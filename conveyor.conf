# https://conveyor.hydraulic.dev/17.0/configs/hocon/

// This is a hashbang include. You can run the command after the #! to see what
// configuration is being extracted from the Gradle build using the Conveyor plugin.
include "#!./gradlew -q printConveyorConfig"

// This enables native library extraction, which improves app startup time and robustness.
// It's optional but a good idea to have it. You can remove this if you get tired of specifying
// system properties for Java libraries with native components.
//
// See https://hydraulic.dev/blog/11-in-jar-signing.html for more.
include required("https://raw.githubusercontent.com/hydraulic-software/conveyor/master/configs/jvm/extract-native-libraries.conf")

# https://conveyor.hydraulic.dev/17.0/stdlib/jdks/
# It is not possible to override the JDK version in the config file; the `conveyor` command complains that both the toolchain and the config specfiy a JDK version.
//include required("/stdlib/jdk/17/eclipse.conf")

# Config file documentation: https://conveyor.hydraulic.dev/latest/configs
app {
  # https://conveyor.hydraulic.dev/17.0/configs/names/#names-and-metadata
  # Increment if the config file contents change but the application does not, reset to 0 if the app version changes
  revision = 0
  rdns-name = "com.swisscom.health.des.cdr.cdr-client"
  display-name = "CDR Client"
  vendor = "Swisscom (Schweiz) AG"
  description = "Client application to connect to Swisscom's Confidential Document Routing (CDR) service for participants in the Swiss healthcare system."
  license = "Apache-2.0"
  contact-email = "support.curax@swisscom.com"

  # https://conveyor.hydraulic.dev/17.0/configs/update-modes/
  # Check for and apply updates synchronously on every app launch instead of in the background.
  //  updates = aggressive # other options are `background` (default), `none`, or `manual`
  updates = background # other options are `background` (default), `none`, or `manual`
  # On linux the modes make no difference, updates are always only done via the system's package manager - is that a problem for us?

  # TODO: remove to build all installers, including MacOS and ARM derivatives
  machines = [windows.amd64, linux.amd64.glibc]

  # https://conveyor.hydraulic.dev/17.0/configs/#signing
  # defaults in `~/.config/hydraulic/conveyor/defaults.conf`
  sign = true


  # Does not have to be an SVG. You can use whatever icons you like. They should be rendered as PNGs in a range of square sizes, ideally 32x32, 64x64, 128x128 etc up to 1024x1024.
  # https://conveyor.hydraulic.dev/17.0/tutorial/tortoise/2-gradle/#conveyorconf
  icons = resources/conveyor/icons/Swisscom_Lifeform_RGB_Colour.svg
  windows.inputs += TASK/rendered-icons/windows
  linux.inputs += TASK/rendered-icons/linux

  # https://conveyor.hydraulic.dev/17.0/configs/#misc
  # for iteration speed !!!!! remove for release !!!!! or set to `high`
  compression-level = low

  # https://conveyor.hydraulic.dev/17.0/configs/#theme
  //  theme = dark

  # update site - can be a directory, http/ftp site, s3, or a github site
  # to publish to `/var/conveyor/sites/cdr-client` run `conveyor make copied-site` (will leave an empty `output` directory in the project root)
  site {
    # https://conveyor.hydraulic.dev/17.0/configs/download-pages/#synopsis
    display-name = "CDR Client"
    base-url = "localhost:3000"
    icons = resources/conveyor/icons/Swisscom_Horizontal_RGB_Colour_Navy.svg
    # share `/var/conveyor/sites/cdr-client` with `npx serve`
    copy-to = "/var/conveyor/sites/cdr-client"
    # https://conveyor.hydraulic.dev/17.0/configs/download-pages/#publishing-through-github
    //    github {
    //      oauth-token = ${env.GITHUB_TOKEN}
    //      # Expires on Sat, Apr 5 2025
    //      oauth-token = "github_pat_xxxxxxxxxxxxxxxxxxxx"
    //
    //      # Optional: upload the download site to a branch.
    //      //pages-branch = "gh-pages"
    //    }
  }

  windows {
    exe-installer-basename = "cdr-client-installer"
    # Open a console for the app, even when starting from a graphical launcher
    # https://conveyor.hydraulic.dev/17.0/configs/jvm/#launcher-features
    console = true
    # https://conveyor.hydraulic.dev/17.0/configs/#signing
    # set to a pem or pkcs12 file containing the private key, path is relative to the app config file
    signing-key = derived
    # TODO: replace the defaults below with certs, path is relative to the app config file
    certificate = "self signed by CN=CDR Client"
    amd64 {
      # https://conveyor.hydraulic.dev/17.0/configs/inputs/#machine-specific-inputs
      # https://conveyor.hydraulic.dev/17.0/configs/jvm/#importing-app-files
      //      inputs += resources/conveyor/nssm.exe
      inputs += resources/conveyor/winsw-x64.exe
      package-extras += {
        to = "./bin/winsw-x64.xml"
        content = """
          <service>
            <id>CDRClientService</id>
            <name>Cdr Client</name>
            <description>CDR Client service</description>
            <executable>%BASE%\cdr-client-service.exe</executable>
            <!--workingdirectory>%BASE%</workingdirectory-->
            <logpath>C:/ProgramData/Swisscom/cdr-client</logpath>
            <log mode="append" />
            <!--serviceaccount>
              <domain>NT AUTHORITY</domain>
              <user>LocalService</user>
            </serviceaccount-->
          </service>
        """
      }
    }
    manifests {
      // https://conveyor.hydraulic.dev/17.0/configs/windows/#requesting-administrator-access
      exe.requested-execution-level = requireAdministrator
      msix {
//        namespaces = {
//          uap10: "http://schemas.microsoft.com/appx/manifest/uap/windows10/10"
//        }
//        ignorable-namespaces += "uap10"
//        capabilities = ["rescap:runFullTrust", "rescap:localSystemServices", "rescap:packagedServices", "rescap:allowElevation"]
//        // https://learn.microsoft.com/en-us/uwp/schemas/appxpackage/uapmanifestschema/element-desktop6-extension
//        //
//        extensions-xml = """
//          <desktop6:Extension Category="windows.service" EntryPoint="Windows.FullTrustApplication" Executable="bin\winsw-x64.exe" uap10:RuntimeBehavior="win32App">
//               <desktop6:Service Name="CDRClientService" StartAccount="localSystem" StartupType="manuall" />
//          </desktop6:Extension>
//        """
        # TODO: resolve version via variable? possible?
        content = """
          <?xml version="1.0" encoding="utf-8"?>
          <Package IgnorableNamespaces="rescap6 virtualization desktop6 uap7 uap8 uap10 uap11"
                   xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                   xmlns:com="http://schemas.microsoft.com/appx/manifest/com/windows10"
                   xmlns:com2="http://schemas.microsoft.com/appx/manifest/com/windows10/2"
                   xmlns:desktop="http://schemas.microsoft.com/appx/manifest/desktop/windows10"
                   xmlns:desktop2="http://schemas.microsoft.com/appx/manifest/desktop/windows10/2"
                   xmlns:desktop3="http://schemas.microsoft.com/appx/manifest/desktop/windows10/3"
                   xmlns:desktop4="http://schemas.microsoft.com/appx/manifest/desktop/windows10/4"
                   xmlns:desktop5="http://schemas.microsoft.com/appx/manifest/desktop/windows10/5"
                   xmlns:desktop6="http://schemas.microsoft.com/appx/manifest/desktop/windows10/6"
                   xmlns:desktop7="http://schemas.microsoft.com/appx/manifest/desktop/windows10/7"
                   xmlns:desktop8="http://schemas.microsoft.com/appx/manifest/desktop/windows10/8"
                   xmlns:desktop9="http://schemas.microsoft.com/appx/manifest/desktop/windows10/9"
                   xmlns:f2="http://schemas.microsoft.com/appx/manifest/foundation/windows10/2"
                   xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities"
                   xmlns:rescap2="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities/2"
                   xmlns:rescap3="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities/3"
                   xmlns:rescap4="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities/4"
                   xmlns:rescap6="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities/6"
                   xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                   xmlns:uap10="http://schemas.microsoft.com/appx/manifest/uap/windows10/10"
                   xmlns:uap11="http://schemas.microsoft.com/appx/manifest/uap/windows10/11"
                   xmlns:uap2="http://schemas.microsoft.com/appx/manifest/uap/windows10/2"
                   xmlns:uap3="http://schemas.microsoft.com/appx/manifest/uap/windows10/3"
                   xmlns:uap4="http://schemas.microsoft.com/appx/manifest/uap/windows10/4"
                   xmlns:uap5="http://schemas.microsoft.com/appx/manifest/uap/windows10/5"
                   xmlns:uap6="http://schemas.microsoft.com/appx/manifest/uap/windows10/6"
                   xmlns:uap7="http://schemas.microsoft.com/appx/manifest/uap/windows10/7"
                   xmlns:uap8="http://schemas.microsoft.com/appx/manifest/uap/windows10/8"
                   xmlns:virtualization="http://schemas.microsoft.com/appx/manifest/virtualization/windows10">
              <Identity Name="CdrClientUi"
                        Version="1.0.4.0"
                        Publisher="CN=CDR Client"
                        ProcessorArchitecture="x64"/>
              <Properties>
                  <DisplayName>CDR Client</DisplayName>
                  <PublisherDisplayName>Swisscom (Schweiz) AG</PublisherDisplayName>
                  <Description>Client application to connect to Swisscom's Confidential Document Routing (CDR) service for participants in the Swiss healthcare system.</Description>
                  <Logo>ConveyorMsixResources/StoreLogo.png</Logo>
              </Properties>
              <Resources>
                  <Resource Language="en"/>
              </Resources>
              <Applications>
                  <Application Id="CdrClientUi"
                               EntryPoint="Windows.FullTrustApplication"
                               Executable="bin\cdr-client-ui.exe">
                      <uap:VisualElements AppListEntry="default"
                                          DisplayName="CDR Client"
                                          Description="Client application to connect to Swisscom&apos;s Confidential Document Routing (CDR) service for participants in the Swiss healthcare system."
                                          BackgroundColor="transparent"
                                          Square150x150Logo="ConveyorMsixResources/Square150x150Logo.png"
                                          Square44x44Logo="ConveyorMsixResources/Square44x44Logo.png"/>
                      <uap7:Properties>
                          <uap8:ActiveCodePage>UTF-8</uap8:ActiveCodePage>
                      </uap7:Properties>
                      <Extensions>
                          <uap3:Extension Category="windows.appExecutionAlias"
                                          Executable="bin\cdr-client-ui.exe"
                                          EntryPoint="Windows.FullTrustApplication">
                              <uap3:AppExecutionAlias>
                                  <uap8:ExecutionAlias Alias="cdr-client-ui.exe"/>
                              </uap3:AppExecutionAlias>
                          </uap3:Extension>
                      </Extensions>
                  </Application>
                  <Application Id="CdrClientService"
                               EntryPoint="Windows.FullTrustApplication"
                               Executable="bin\cdr-client-service.exe">
                               <uap:VisualElements AppListEntry="none"
                                                   DisplayName="CDR Client (cdr-client-service.exe)"
                                                   Description="Client application to connect to Swisscom's Confidential Document Routing (CDR) service for participants in the Swiss healthcare system."
                                                   BackgroundColor="transparent"
                                                   Square150x150Logo="ConveyorMsixResources/Square150x150Logo.png"
                                                   Square44x44Logo="ConveyorMsixResources/Square44x44Logo.png"/>
                      <uap7:Properties>
                          <uap8:ActiveCodePage>UTF-8</uap8:ActiveCodePage>
                      </uap7:Properties>
                  </Application>
                  <Application Id="WinswX64"
                               EntryPoint="Windows.FullTrustApplication"
                               Executable="bin\winsw-x64.exe">
                    <uap:VisualElements AppListEntry="none"
                                        DisplayName="CDR Client (winsw-x64.exe)"
                                        Description="Client application to connect to Swisscom's Confidential Document Routing (CDR) service for participants in the Swiss healthcare system."
                                        BackgroundColor="transparent"
                                        Square150x150Logo="ConveyorMsixResources/Square150x150Logo.png"
                                        Square44x44Logo="ConveyorMsixResources/Square44x44Logo.png"/>
                      <Extensions>
                          <desktop6:Extension Category="windows.service"
                                              EntryPoint="Windows.FullTrustApplication"
                                              Executable="bin\winsw-x64.exe">
                                              <!--
                                              uap10:RuntimeBehavior="packagedClassicApp"
                                              uap11:Subsystem="console"
                                              desktop7:CompatMode="classic"
                                              desktop7:Scope="machine"
                                              -->
                              <desktop6:Service Name="CDRClientService"
                                                StartAccount="localSystem"
                                                StartupType="manual"/>
                          </desktop6:Extension>
                      </Extensions>
                  </Application>
              </Applications>
              <Capabilities>
                  <rescap:Capability Name="allowElevation"/>
                  <rescap:Capability Name="localSystemServices"/>
                  <rescap:Capability Name="packagedServices"/>
                  <rescap:Capability Name="runFullTrust"/>
                  <!-- required for desktop7 extension attributes
                  <uap4:CustomCapability Name="Microsoft.classicAppCompat_8wekyb3d8bbwe"/>
                  <uap4:CustomCapability Name="Microsoft.classicAppCompatElevated_8wekyb3d8bbwe"/>
                  -->
              </Capabilities>
              <Dependencies>
                  <TargetDeviceFamily Name="Windows.Desktop"
                                      MinVersion="10.0.17763.0"
                                      MaxVersionTested="10.0.26100.2454"/>
              </Dependencies>
              <Extensions />
          </Package>
        """
      }
    }
    // https://conveyor.hydraulic.dev/17.0/configs/windows/#appwindowsupdates
    updates {
      launch-check-frequency = 1 // hours
      block-start = false
      automatic-updates = true
    }
  }

  mac {
    # https://conveyor.hydraulic.dev/17.0/configs/#signing
    # set to a pem or pkcs12 file containing the private key, path is relative to the app config file
    signing-key = derived
    # replace the defaults below with certs, path is relative to the app config file
    # TODO: replace the defaults below with certs, path is relative to the app config file
    certificate = "self signed by CN=CDR Client"
  }

  # https://conveyor.hydraulic.dev/17.0/configs/jvm/#native-code
  jvm {
    system-properties {
      file.encoding = UTF-8
      spring.profiles.active = customer
    }

    # https://conveyor.hydraulic.dev/17.0/configs/jvm/#appjvmoptions
    options += -Xmx512m

    windows.options += "-Dspring.config.additional-location=file:C:/ProgramData/Swisscom/cdr-client/"
    windows.options += "-Dcdr-client-log-location=C:/ProgramData/Swisscom/cdr-client"
    linux.options += "-Dcdr-client-config-location=/etc/Swisscom/cdr-client/"
    linux.options += "-Dcdr-client-log-location=/var/log/Swisscom"

    gui {
      main-class = com.swisscom.health.des.cdr.client.ui.UiMainKt
      exe-name = cdr-client-ui
      console = true
    }

    cli {
      cdr-client-service {
        main-class = com.swisscom.health.des.cdr.client.CdrClientApplicationKt
        console = true
      }
    }

    # https://conveyor.hydraulic.dev/17.0/configs/jvm/#native-code
    # TODO: comment in once everything works
    //    extract-native-library = true

    # https://conveyor.hydraulic.dev/17.0/configs/jvm/#localization
    # TODO: make this work; could be that only the MacOS ARM version does not support this?
    //    jlink-flags += "--add-modules jdk.localedata"
    //    jlink-flags += " --include-locales=en,de"
  }
}

conveyor.compatibility-level = 17
